name: CI

on:
  push:
  pull_request:

jobs:
  backend-tests-and-analysis:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: rirs
          POSTGRES_PASSWORD: secretpassword
          POSTGRES_DB: rirs
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U rirs"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for SonarCloud

      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Wait for Postgres
        run: |
          until docker exec ${{ job.services.postgres.id }} pg_isready -U rirs; do
            echo "Waiting for Postgres..."
            sleep 2
          done

      - name: Run backend tests with coverage
        working-directory: backend
        env:
          DATABASE_URL: postgresql://rirs:secretpassword@localhost:5432/rirs
        # Ensure your jest config or script generates coverage (lcov format)
        run: npm test -- --coverage 

      - name: SonarCloud Scan (Backend)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: backend

      # Ta korak prisili cevovod, da počaka na rezultat in spodleti, če Quality Gate ni opravljen
      - name: SonarCloud Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  frontend-tests-and-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: npm run test:ci # -- --coverage

      - name: SonarCloud Scan (Frontend)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: frontend
      
      # Ta korak prisili cevovod, da počaka na rezultat in spodleti, če Quality Gate ni opravljen
      - name: SonarCloud Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


  deploy:
    runs-on: ubuntu-latest
    needs: [backend-tests-and-analysis, frontend-tests-and-analysis] # Čaka na oba statusa
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .